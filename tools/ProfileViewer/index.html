<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
	<title>Profile viewer</title>  
	
	<!-- Load CSS -->
	<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.10.custom.css" rel="stylesheet" />
	<link href="css/jquery.treeTable.css" rel="stylesheet" type="text/css"/>
	<link href="css/profile.css" rel="stylesheet" type="text/css"/>
	
	<!-- Load jsChart -->
  <script type="text/javascript" src="js/jscharts.js"></script>
	
	<!-- Load jQuery & jQuery UI -->
	<script type="text/javascript" src="js/jquery-1.4.4.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui-1.8.10.custom.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui-1.8.10.custom.min.js"></script>
	
	<!-- Load jQuery plugins -->
	<script type="text/javascript" src="js/jquery.treeTable.js"></script>
		
	<script type="text/javascript" src="js/ui.js"></script>
	
	<!-- Load V8 profile tools -->
	<!--<script type="text/javascript" src="js/v8/splaytree.js"></script>
	<script type="text/javascript" src="js/v8/codemap.js"></script>
	<script type="text/javascript" src="js/v8/csvparser.js"></script>
	<script type="text/javascript" src="js/v8/consarray.js"></script>
	<script type="text/javascript" src="js/v8/profile.js"></script>
	<script type="text/javascript" src="js/v8/profile_view.js"></script>
	<script type="text/javascript" src="js/v8/logreader.js"></script>
	<script type="text/javascript" src="js/v8/tickprocessor.js"></script>
	<script type="text/javascript" src="js/v8/tickprocessor-driver.js"></script>
	<script type="text/javascript" src="js/analysis.js"></script>-->
</head>
<body> 
  <script type="text/javascript">
    /* Options */
    var jsonOnly = true;
  
    var activity;
    var btnLoad;
    var btnAnalyze;
    
    var logData;
    
    var worker;
    
    function print() {
        // Importing d8 code can cause calls to print, so override it here
        console.log(arguments);
    }
    
    $(document).ready(function() {
    
    	if (window.File && window.FileReader) {
    	    // Success!
    	} else {
    		  alert("This browser does not support the required File APIs");
    	}
    	
    	activity = document.getElementById("activity");
    	btnLoad = document.getElementById("load");
    	btnAnalyze = document.getElementById("analyze");
    	btnTerminate = document.getElementById("terminate");
    	
    	btnLoad.disabled = true;
    	// btnAnalyze.disabled = true;
    	$("#progress").hide();
    	$("#progress").progressbar({
    				value: 0
    	});
    	
    	$("#flat").tabs();
    	$("#tree").tabs();
    	
    	document.getElementById("file").addEventListener("change", onFileSelected, false);    	
    	
    	if (jsonOnly) {
    	    $(btnLoad).hide();
    	    $(btnAnalyze).hide();
    	    $(btnTerminate).hide();
    	} else {
    	    worker = new Worker('js/analysis.js');
    	    worker.onmessage = onWorkerMessage;
    	}
    });
    
    function onReadError(e) {
      switch(e.target.error.code) {
        case e.target.error.NOT_FOUND_ERR:
          alert('File Not Found!');
          break;
        case e.target.error.NOT_READABLE_ERR:
          alert('File is not readable');
          break;
        case e.target.error.ABORT_ERR:
          break; // noop
        default:
          alert('An error occurred reading this file.');
      };
    }
    
    function onFileSelected(e) {
        if (jsonOnly) {
            load();
        } else {
            btnLoad.disabled = false;
        }
    }    
    
    function onProgressUpdate(e) {
       if (e.lengthComputable) {
           var perc = Math.round((e.loaded / e.total) * 100);
           $("#progress").progressbar("value", perc);
       }
    }
    
    function onLoadStart(e) {
        activity.textContent = "Loading file...";
        $("#progress").show();
        $("#progress").progressbar("value", 0);
    }
    
    function onFileLoaded(e) {
        $("#progress").progressbar("value", 100);
        activity.textContent = "File loaded";
        logData = e.target.result;
        if (jsonOnly) {
            var msg = JSON.parse(logData);
            handleWorkerMessage(msg);
        } else {
            btnAnalyze.disabled = false;
        }
        $("#progress").hide();
    }
    
    function load() {
        var selectedFile = document.getElementById("file").files[0];
        var reader = new FileReader();
        reader.onerror = onReadError;
        reader.onloadstart = onLoadStart;
        reader.onprogress = onProgressUpdate;
        reader.onload = onFileLoaded;
        reader.onabort = function(e) {
            alert('File read cancelled');
        };
        reader.readAsText(selectedFile);
    }
    
    function onWorkerMessage(e) {
        handleWorkerMessage(e.data);
    }
    
    function handleWorkerMessage(msg) {
        console.log("Received message: " + msg.kind);        
        if (msg.kind === "done") {
            onAnalysisDone();
        } else if (msg.kind === "stats") {
            outputStats('stats', msg.data);
        } else if (msg.kind === "flat") {
            var profiles = msg.data;
            for (var i = 0; i < profiles.data.length; i++) {
                var p = profiles.data[i];
                var container = document.getElementById('flat-' + p.name);
                if (container) {
                    outputFlatProfile(container, profiles.headers, p.data);
                }
            }
            // outputFlatProfiles(document.getElementById('flat-js'), msg.data);
        } else if (msg.kind === "bottomUp") {
            var count = 0;
            outputTreeProfile(document.getElementById("tree-bottom"), msg.data, function () {
                return "prof-bu-" + (count++);
            });
        } else if (msg.kind === "topDown") {
             var count = 0;
            outputTreeProfile(document.getElementById("tree-top"), msg.data, function () {
                return "prof-td-" + (count++);
            });
        } else if (msg.kind === 'multi') {
            for (var i = 0; i < msg.data.length; i++) {
                handleWorkerMessage(msg.data[i]);
            }
        }
    }    
    
    function onAnalysisDone() {
        activity.textContent = "Analysis done";        
    }
    
    function performAnalysis() {
        activity.textContent = "Performing analysis...";
        worker.postMessage(logData);        
    }
        
    function terminate() {
        worker.terminate();
    }
    
    /*
    function analyze() {        
        var args = [ "--mac"];
        var proc = makeTickProcessor(args);
        if (proc) {
            activity.textContent = proc.ticks_.total + " ticks loaded";
        } else {
            activity.textContent = "Analysis failed";
        }
    }
    */
  </script>
  
  <h1>Profile viewer</h1>
  
  <input type="file" id="file" name="file" />
  <button id="load" onclick="load();">Load</button>
  <button id="analyze" onclick="performAnalysis();">Analyze</button>
  <button id="terminate" onClick="terminate();">Terminate</button>
  <div id="activity">No file selected</div>
  <div id="progress"></div>
  
  <div id="contents">
    <div id="stats" class="section">
       <span class="nodata"></span>
    </div>
    
    <div id="flat" class="section">
      <ul>
      	<li><a href="#flat-js">Javascript</a></li>
      	<li><a href="#flat-cpp">C++</a></li>
      	<li><a href="#flat-libs">Standard Libs</a></li>
      </ul>
      <div id="flat-js">
        <span class="nodata"></span>
      </div>
      <div id="flat-cpp">
        <span class="nodata"></span>
      </div>
      <div id="flat-libs">
        <span class="nodata"></span>
      </div>
    </div>
    
    <div id="tree" class="section">
      <ul>
      	<li><a href="#tree-bottom">Bottom-up (Heavy)</a></li>
      	<li><a href="#tree-top">Top-down</a></li>
      </ul>
      <div id="tree-bottom">
        <span class="nodata"></span>
      </div>
      <div id="tree-top">
        <span class="nodata"></span>
      </div>      
    </div>
  </div>
</body>
</html>