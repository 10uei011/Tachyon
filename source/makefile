# makefile for Tachyon JavaScript compiler

ROOT_DIR = `(cd ..;pwd)`

#JavaScript VM program
JSVMPROG = d8
JSVMPROG64 = d8_64

#JavaScript VM command options
JSVMOPTS = --allow_natives_syntax --nocollect_maps

#JavaScript VM command options when debugging
JSVMOPTSDEBUG = $(JSVMOPTS) --noopt

#JavaScript VM command
JSVM = $(JSVMPROG) $(JSVMOPTS)
JSVM64 = $(JSVMPROG64) $(JSVMOPTS)

# JavaScript VM command with rlwrap
RLWJSVM = rlwrap $(JSVM)
RLWJSVM64 = rlwrap $(JSVM64)

# For bootstrapping with Tachyon JavaScript to Scheme compiler
JS2SCM = parser/js2scm

# For debugging Tachyon
JS2JS = parser/js2js

# Base program source files
BASE_SRCS =                             \
    utility/debug.js                    \
    utility/system.js                   \
    utility/iterators.js                \
    utility/graph.js                    \
    utility/arrays.js                   \
    utility/heap.js                     \
    utility/hashmap.js                  \
    utility/hashset.js                  \
    utility/linkedlist.js               \
    utility/strings.js                  \
    utility/modules.js                  \
    utility/misc.js                     \
    utility/num.js                      \
    utility/xml.js                      \
    utility/html.js                     \
    compiler/targets.js                 \
    compiler/params.js                  \
    compiler/config.js                  \
    compiler/compiler.js                \
    compiler/init.js                    \
    compiler/bootstrap.js               \
    parser/misc.js                      \
    parser/scanner.js                   \
    parser/parser.js                    \
    parser/pp.js                        \
    parser/ast-passes.js                \
    ir/types.js                         \
    ir/static.js                        \
    ir/instructions.js                  \
    ir/constants.js                     \
    ir/iir.js                           \
    ir/cfg.js                           \
    ir/functions.js                     \
    ir/ast-to-ir.js                     \
    ir/optpatterns.js                   \
    ir/constprop.js                     \
    ir/commelim.js                      \
    ir/inlining.js                      \
    ir/lowering.js                      \
    runtime/layout.js                   \
    runtime/context.js                  \
    runtime/objects.js                  \
    runtime/misc.js                     \
    platform/ffi.js                     \
    platform/mcb.js                     \
    backend/asm.js                      \
    backend/regalloc.js                 \
    backend/linearscan.js               \
    backend/backend.js                  \
    backend/x86/asm.js                  \
    backend/x86/config.js               \
    backend/x86/ir-to-asm.js

# Runtime library source files
RUNTIME_SRCS =                          \
    runtime/utility.js                  \
    runtime/primitives.js               \
    runtime/strings.js                  \
    runtime/ffi.js                      \
    runtime/rtinit.js

# Standard library source files
STDLIB_SRCS =                           \
    stdlib/object.js                    \
    stdlib/function.js                  \
    stdlib/array.js                     \
    stdlib/error.js                     \
    stdlib/number.js                    \
    stdlib/string.js                    \
    stdlib/math.js                      \
    stdlib/date.js                      \
    stdlib/json.js                      \
    stdlib/extensions.js

# Main-specific source files
MAIN_SPEC_SRCS =                        \
    main.js

# Test-specific source files
# Insert unit test files between testing.js and testmain.js
TEST_SPEC_SRCS =                        \
    tests/testing.js                    \
    utility/tests/*.js                  \
    stdlib/tests/*.js                   \
    ir/tests/*.js                       \
    runtime/tests/*.js                  \
    backend/tests/*.js                  \
    programs/tests/programs.js          \
    tests/testmain.js                   \

# Main target source files
MAIN_SRCS =                             \
    $(BASE_SRCS)                        \
    $(MAIN_SPEC_SRCS)

# Test target source files
TEST_SRCS =                             \
    $(BASE_SRCS)                        \
    $(TEST_SPEC_SRCS)

# All source files
ALL_SRCS =                              \
    $(RUNTIME_SRCS)                     \
    $(STDLIB_SRCS)                      \
    $(BASE_SRCS)                        \
    $(MAIN_SPEC_SRCS)                   \
    $(TEST_SPEC_SRCS)

all: tachyon

tachyon: makefile tachyon.in
	rm -f tachyon
	sed -e "s:@JSVMPROG@:$(JSVMPROG):g" -e "s:@ROOT_DIR@:$(ROOT_DIR):g" -e "s:@BASE_SRCS@:$(BASE_SRCS):g" -e "s:@RUNTIME_SRCS@:$(RUNTIME_SRCS):g" -e "s:@STDLIB_SRCS@:$(STDLIB_SRCS):g" -e "s:@MAIN_SPEC_SRCS@:$(MAIN_SPEC_SRCS):g" -e "s:@TEST_SPEC_SRCS@:$(TEST_SPEC_SRCS):g" tachyon.in > tachyon
	chmod +x tachyon

load:
	$(JSVM) $(BASE_SRCS) --shell

run:
	$(JSVM) $(MAIN_SRCS)

shell:
	$(RLWJSVM) $(MAIN_SRCS)

shell64:
	$(RLWJSVM64) $(MAIN_SRCS) -- -x86_64

bt-parser:
	$(JSVM) $(BASE_SRCS) bt-parser.js bt-parser32.js

bt-parser64:
	$(JSVM64) $(BASE_SRCS) bt-parser.js bt-parser64.js

mem-fib:
	$(JSVM) --no-opt --trace_gc --trace_gc_nvp $(BASE_SRCS) test-fib.js > gc_trace.txt && python mem.py

gc:
	$(JSVM) $(MAIN_SRCS) -- -gc
	gcc -c -o d8/gc-generated.o d8/gc-generated.cc

bootstrap:
	time $(JSVM) $(MAIN_SRCS) -- -bootstrap

bootstrap64:
	time $(JSVM64) $(MAIN_SRCS) -- -bootstrap -x86_64

bootstrap-debug:
	echo "run $(JSVMOPTSDEBUG) $(MAIN_SRCS) -- -bootstrap" > gdb-command
	echo "bt"                                              >> gdb-command
	time gdb --command=gdb-command $(JSVMPROG)

test:
	$(JSVM) $(TEST_SRCS)

test64:
	$(JSVM64) $(TEST_SRCS) -- -x86_64

perf:
	./bench/d8.sh                                   \
        -cfgFile "bench/configs/time_benchs.json"   \
        -genReport "benchreport.html"

bootstrap-js2scm:
	$(JS2SCM) -scm $(MAIN_SRCS)

bootstrap-js2scm-debug:
	$(JS2SCM) -scm -debug $(MAIN_SRCS)

tachyon-debug.js: $(MAIN_SRCS)
	$(JS2JS) -debug $(MAIN_SRCS) > tachyon-debug.js

doc: $(SRCS)
	jsdoc -d=../doc/source $(MAIN_SRCS)

snapshot: makefile d8/d8-tachyon-exts.cc $(ALL_SRCS)
	rm -rf tachyon-snapshot tachyon-snapshot.tar.gz
	mkdir tachyon-snapshot
	(tar cf - $^ | (cd tachyon-snapshot ; tar xf -))
	tar cf tachyon-snapshot.tar tachyon-snapshot
	gzip -9 tachyon-snapshot.tar
